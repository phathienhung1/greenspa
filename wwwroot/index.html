
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Tạo lịch hẹn</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body{background:#f8fafc}
    .card{border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,0.06)}
    .brand{font-weight:800; letter-spacing:.5px}
  </style>
</head>
<body class="p-3">
  <div class="container" style="max-width:560px">
    <div class="text-center mb-3">
      <div class="brand">KTVGREEN</div>
      <div class="text-muted">Tạo lịch hẹn nhanh</div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-6">
            <label class="form-label">Chi nhánh</label>
            <select id="branch" class="form-select">
              <option value="1">Trung tâm</option>
              <option value="2">Chi nhánh 2</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label">Ngày</label>
            <input id="day" type="date" class="form-control">
          </div>
          <div class="col-6">
            <label class="form-label">Bắt đầu</label>
            <input id="start" type="time" class="form-control" value="10:00">
          </div>
          <div class="col-6">
            <label class="form-label">Kết thúc</label>
            <input id="end" type="time" class="form-control" value="11:00">
          </div>
          <div class="col-12">
            <label class="form-label">Khách hàng</label>
            <input id="customer" class="form-control" placeholder="Tên khách">
          </div>
          <div class="col-12">
            <label class="form-label">Điện thoại</label>
            <input id="phone" class="form-control" inputmode="tel" placeholder="SĐT">
          </div>
          <div class="col-12">
            <label class="form-label">Dịch vụ</label>
            <input id="services" class="form-control" placeholder="VD: Massage 90p">
          </div>
          <div class="col-12 form-check ms-2">
            <input class="form-check-input" type="checkbox" id="paid">
            <label class="form-check-label" for="paid">Đã thanh toán</label>
          </div>
          <div class="col-12 d-grid">
            <button id="btnCreate" class="btn btn-success btn-lg">Tạo lịch</button>
          </div>
          <div class="col-12">
            <div id="msg" class="text-success small"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <h6 class="text-muted">Lịch trong ngày</h6>
      <table class="table table-sm table-striped" id="tbl">
        <thead><tr><th>Giờ</th><th>Khách</th><th>Dịch vụ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const dayEl = document.getElementById('day');
dayEl.value = new Date().toISOString().slice(0,10);

function combineDateTime(d, t){ return new Date(d + "T" + t + ":00"); }
function toIsoLocal(dt){
  const pad = n => n.toString().padStart(2,'0');
  return dt.getFullYear()+"-"+pad(dt.getMonth()+1)+"-"+pad(dt.getDate())+"T"+pad(dt.getHours())+":"+pad(dt.getMinutes())+":00";
}
async function loadList(){
  const branchId = document.getElementById('branch').value;
  const day = document.getElementById('day').value;
  const url = "/api/appointments?branchId="+encodeURIComponent(branchId)+"&day="+encodeURIComponent(day);
  const res = await fetch(url);
  const list = await res.json();
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  list.forEach(x => {
    const tr = document.createElement("tr");
    const start = new Date(x.start);
    const end = new Date(x.end);
    const time = start.toTimeString().slice(0,5)+"-"+end.toTimeString().slice(0,5);
    tr.innerHTML = "<td>"+time+"</td><td>"+(x.customerName||"")+"</td><td>"+(x.services||"")+"</td>";
    tb.appendChild(tr);
  });
}

document.getElementById('btnCreate').addEventListener('click', async () => {
  const branchId = parseInt(document.getElementById('branch').value,10);
  const day = document.getElementById('day').value;
  const start = toIsoLocal(combineDateTime(day, document.getElementById('start').value));
  const end = toIsoLocal(combineDateTime(day, document.getElementById('end').value));
  const body = {
    start, end, branchId,
    customerName: document.getElementById('customer').value,
    phone: document.getElementById('phone').value,
    services: document.getElementById('services').value,
    invoiceCode: "",
    paid: document.getElementById('paid').checked
  };
  const res = await fetch("/api/appointments", {
    method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)
  });
  if(res.ok){
    document.getElementById('msg').textContent = "Đã tạo lịch!";
    await loadList();
  }else{
    document.getElementById('msg').textContent = "Lỗi tạo lịch.";
  }
});

dayEl.addEventListener('change', loadList);
document.getElementById('branch').addEventListener('change', loadList);
loadList();
</script>
</body>
</html>
